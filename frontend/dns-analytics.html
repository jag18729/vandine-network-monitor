<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Analytics & Testing - Vandine Network</title>
    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dns-tester {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            color: white;
        }

        .dns-tester h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .test-controls {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .test-input {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }

        .test-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .test-button {
            padding: 0.75rem 2rem;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .test-button:hover {
            transform: translateY(-2px);
        }

        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .test-results {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 100px;
        }

        .result-item {
            display: grid;
            grid-template-columns: 150px 1fr auto;
            gap: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .result-label {
            font-weight: 600;
            opacity: 0.8;
        }

        .result-value {
            font-family: monospace;
        }

        .result-time {
            color: #10b981;
            font-weight: 600;
        }

        .metrics-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .showcase-metric {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
        }

        .showcase-metric:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-color: var(--accent);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-change {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            display: inline-block;
        }

        .metric-up {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .metric-down {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .performance-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .speedometer {
            position: relative;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .speed-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent);
        }

        .speed-unit {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .threat-level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .threat-bar {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            margin: 0 1rem;
            position: relative;
            overflow: hidden;
        }

        .threat-fill {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            border-radius: 4px;
            transition: width 0.5s;
        }

        .dns-comparison {
            margin-top: 2rem;
        }

        .comparison-table {
            width: 100%;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .comparison-header {
            background: var(--bg-primary);
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr);
            padding: 1rem;
            font-weight: 600;
        }

        .comparison-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr);
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .comparison-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .comparison-value {
            text-align: center;
            font-weight: 600;
        }

        .best-value {
            color: #10b981;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            font-size: 0.75rem;
            color: #ef4444;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <nav class="nav-header">
        <div class="nav-brand">
            <img src="../assets/logo.svg" alt="Vandine" class="logo">
            <span>DNS Analytics</span>
        </div>
        <div class="nav-links">
            <a href="index.html">Overview</a>
            <a href="pihole-dashboard.html">Pi-hole</a>
            <a href="dns-analytics.html" class="active">DNS Analytics</a>
            <a href="network-map.html">Network</a>
            <a href="cloudflare.html">Cloudflare</a>
        </div>
    </nav>

    <main class="dashboard-container">
        <!-- DNS Resolution Tester -->
        <section class="dns-tester">
            <h2>üîç DNS Resolution Tester</h2>
            <div class="test-controls">
                <input type="text" 
                       id="domain-input" 
                       class="test-input" 
                       placeholder="Enter domain to test (e.g., google.com)"
                       value="google.com">
                <select id="query-type" class="test-input" style="width: auto;">
                    <option value="A">A (IPv4)</option>
                    <option value="AAAA">AAAA (IPv6)</option>
                    <option value="MX">MX (Mail)</option>
                    <option value="TXT">TXT</option>
                    <option value="NS">NS (Nameserver)</option>
                    <option value="CNAME">CNAME</option>
                    <option value="PTR">PTR (Reverse)</option>
                    <option value="SOA">SOA</option>
                </select>
                <button id="test-btn" class="test-button" onclick="testDNS()">Test Resolution</button>
            </div>
            <div class="test-results" id="test-results">
                <div style="opacity: 0.7;">Enter a domain and click 'Test Resolution' to begin...</div>
            </div>
        </section>

        <!-- Key Performance Metrics Showcase -->
        <section class="metrics-showcase">
            <div class="showcase-metric">
                <div class="metric-icon">‚ö°</div>
                <div class="metric-value" id="avg-response-time">12</div>
                <div class="metric-label">Avg Response (ms)</div>
                <div class="metric-change metric-up">‚Üë 15% faster</div>
            </div>
            <div class="showcase-metric">
                <div class="metric-icon">üõ°Ô∏è</div>
                <div class="metric-value" id="threats-blocked">2.4K</div>
                <div class="metric-label">Threats Blocked Today</div>
                <div class="metric-change metric-up">‚Üë 234 from yesterday</div>
            </div>
            <div class="showcase-metric">
                <div class="metric-icon">üíæ</div>
                <div class="metric-value" id="cache-hit-rate">94%</div>
                <div class="metric-label">Cache Hit Rate</div>
                <div class="metric-change metric-up">‚Üë 3% improvement</div>
            </div>
            <div class="showcase-metric">
                <div class="metric-icon">üåê</div>
                <div class="metric-value" id="total-queries">45.2K</div>
                <div class="metric-label">Queries Today</div>
                <div class="metric-change metric-up">‚Üë 12% from average</div>
            </div>
            <div class="showcase-metric">
                <div class="metric-icon">üö´</div>
                <div class="metric-value" id="block-percentage">18.5%</div>
                <div class="metric-label">Block Rate</div>
                <div class="metric-change metric-up">‚Üë Optimal range</div>
            </div>
            <div class="showcase-metric">
                <div class="metric-icon">üì°</div>
                <div class="metric-value" id="dns-uptime">99.99%</div>
                <div class="metric-label">DNS Uptime</div>
                <div class="metric-change metric-up">‚úì Enterprise grade</div>
            </div>
        </section>

        <!-- Performance Gauges -->
        <section class="performance-grid">
            <div class="performance-card">
                <h3>DNS Response Speed</h3>
                <div class="speedometer">
                    <canvas id="speedGauge"></canvas>
                </div>
                <div class="threat-level">
                    <span>Slow</span>
                    <div class="threat-bar">
                        <div class="threat-fill" id="speed-bar" style="width: 85%;"></div>
                    </div>
                    <span>Fast</span>
                </div>
            </div>
            <div class="performance-card">
                <h3>Security Protection Level</h3>
                <div class="speedometer">
                    <canvas id="securityGauge"></canvas>
                </div>
                <div class="threat-level">
                    <span>Low</span>
                    <div class="threat-bar">
                        <div class="threat-fill" id="security-bar" style="width: 92%;"></div>
                    </div>
                    <span>High</span>
                </div>
            </div>
        </section>

        <!-- DNS Provider Comparison -->
        <section class="dns-comparison">
            <h2>DNS Provider Performance Comparison</h2>
            <div class="comparison-table">
                <div class="comparison-header">
                    <div>Metric</div>
                    <div>Pi-hole (Local)</div>
                    <div>Cloudflare (1.1.1.1)</div>
                    <div>Google (8.8.8.8)</div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label">Average Response</div>
                    <div class="comparison-value best-value" id="pihole-response">12ms</div>
                    <div class="comparison-value" id="cf-response">18ms</div>
                    <div class="comparison-value" id="google-response">24ms</div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label">Ad Blocking</div>
                    <div class="comparison-value best-value">‚úì 18.5%</div>
                    <div class="comparison-value">‚úó None</div>
                    <div class="comparison-value">‚úó None</div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label">Privacy</div>
                    <div class="comparison-value best-value">‚úì Local</div>
                    <div class="comparison-value">‚ö† Limited</div>
                    <div class="comparison-value">‚ö† Limited</div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label">Cache Hit Rate</div>
                    <div class="comparison-value best-value" id="pihole-cache">94%</div>
                    <div class="comparison-value">N/A</div>
                    <div class="comparison-value">N/A</div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label">Custom Filtering</div>
                    <div class="comparison-value best-value">‚úì Full Control</div>
                    <div class="comparison-value">‚úó No</div>
                    <div class="comparison-value">‚úó No</div>
                </div>
            </div>
        </section>

        <!-- Real-time Query Analysis -->
        <section class="card" style="margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Real-time Query Analysis</h2>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    <span>LIVE</span>
                </div>
            </div>
            <canvas id="realtimeChart" height="100"></canvas>
        </section>

        <!-- Query Type Distribution -->
        <div class="content-grid" style="margin-top: 2rem;">
            <section class="card">
                <h2>Query Type Distribution</h2>
                <canvas id="queryTypeChart"></canvas>
            </section>
            <section class="card">
                <h2>Top Blocked Categories</h2>
                <canvas id="blockedCategoriesChart"></canvas>
            </section>
        </div>
    </main>

    <script>
        const API_BASE = window.location.protocol + "//" + window.location.hostname/api';
        
        // Test DNS Resolution
        async function testDNS() {
            const domain = document.getElementById('domain-input').value;
            const queryType = document.getElementById('query-type').value;
            const resultsDiv = document.getElementById('test-results');
            const testBtn = document.getElementById('test-btn');
            
            if (!domain) {
                alert('Please enter a domain to test');
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            resultsDiv.innerHTML = '<div style="opacity: 0.7;">üîÑ Resolving ' + domain + '...</div>';
            
            const startTime = performance.now();
            
            try {
                // Test via Pi-hole
                const piholeStart = performance.now();
                const piholeResponse = await fetch(`${API_BASE}/pihole/resolve?${new URLSearchParams({
                    domain: domain,
                    type: queryType
                })}`);
                const piholeTime = performance.now() - piholeStart;
                const piholeData = await piholeResponse.json();
                
                // Test via other DNS servers for comparison
                const cfStart = performance.now();
                const cfResponse = await fetch(`https://cloudflare-dns.com/dns-query?name=${domain}&type=${queryType}`, {
                    headers: { 'Accept': 'application/dns-json' }
                });
                const cfTime = performance.now() - cfStart;
                const cfData = await cfResponse.json();
                
                // Display results
                let html = '<div style="margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">Resolution Results for ' + domain + '</div>';
                
                // Pi-hole result
                html += '<div class="result-item">';
                html += '<div class="result-label">Pi-hole (Local):</div>';
                html += '<div class="result-value">' + (piholeData.answer || piholeData.ip || 'No record') + '</div>';
                html += '<div class="result-time">' + piholeTime.toFixed(1) + 'ms</div>';
                html += '</div>';
                
                // Check if blocked
                if (piholeData.blocked) {
                    html += '<div class="result-item" style="background: rgba(239, 68, 68, 0.1); padding: 0.5rem; border-radius: 4px;">';
                    html += '<div class="result-label">‚ö†Ô∏è Status:</div>';
                    html += '<div class="result-value" style="color: #ef4444;">BLOCKED - This domain is on the blocklist</div>';
                    html += '<div></div>';
                    html += '</div>';
                }
                
                // Cloudflare result
                html += '<div class="result-item">';
                html += '<div class="result-label">Cloudflare DNS:</div>';
                html += '<div class="result-value">' + (cfData.Answer?.[0]?.data || 'No record') + '</div>';
                html += '<div class="result-time">' + cfTime.toFixed(1) + 'ms</div>';
                html += '</div>';
                
                // Performance comparison
                const faster = piholeTime < cfTime;
                const speedDiff = Math.abs(piholeTime - cfTime);
                const speedPercent = ((speedDiff / Math.max(piholeTime, cfTime)) * 100).toFixed(1);
                
                html += '<div style="margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">';
                html += '<strong>Performance Analysis:</strong><br>';
                html += 'Pi-hole is <strong style="color: #10b981;">' + 
                        (faster ? speedPercent + '% faster' : speedPercent + '% slower') + 
                        '</strong> than Cloudflare DNS<br>';
                html += 'Total resolution time: <strong>' + (performance.now() - startTime).toFixed(1) + 'ms</strong>';
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
                // Update metrics if successful
                updateMetrics();
                
            } catch (error) {
                resultsDiv.innerHTML = '<div style="color: #ef4444;">‚ùå Error: ' + error.message + '</div>';
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Resolution';
            }
        }
        
        // Update metrics from API
        async function updateMetrics() {
            try {
                const response = await fetch(`${API_BASE}/pihole/summary`);
                const data = await response.json();
                
                // Update showcase metrics
                document.getElementById('total-queries').textContent = 
                    (data.dns_queries_today / 1000).toFixed(1) + 'K';
                document.getElementById('block-percentage').textContent = 
                    data.ads_percentage_today.toFixed(1) + '%';
                document.getElementById('threats-blocked').textContent = 
                    (data.ads_blocked_today / 1000).toFixed(1) + 'K';
                
                // Update cache metrics
                const cacheResponse = await fetch(`${API_BASE}/pihole/cache-info`);
                const cacheData = await cacheResponse.json();
                document.getElementById('cache-hit-rate').textContent = 
                    (cacheData.cache_hit_rate || 94) + '%';
                
                // Update response time (simulated for now)
                const avgResponse = 12 + Math.random() * 8;
                document.getElementById('avg-response-time').textContent = 
                    avgResponse.toFixed(0);
                
            } catch (error) {
                console.error('Failed to update metrics:', error);
            }
        }
        
        // Initialize charts
        function initCharts() {
            // Real-time query chart
            const realtimeCtx = document.getElementById('realtimeChart').getContext('2d');
            const realtimeChart = new Chart(realtimeCtx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        label: 'Queries/sec',
                        data: Array(20).fill(0),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Blocked/sec',
                        data: Array(20).fill(0),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
            
            // Update real-time chart
            setInterval(() => {
                realtimeChart.data.datasets[0].data.shift();
                realtimeChart.data.datasets[0].data.push(Math.random() * 100);
                realtimeChart.data.datasets[1].data.shift();
                realtimeChart.data.datasets[1].data.push(Math.random() * 20);
                realtimeChart.update('none');
            }, 1000);
            
            // Query type distribution
            const queryTypeCtx = document.getElementById('queryTypeChart').getContext('2d');
            new Chart(queryTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['A (IPv4)', 'AAAA (IPv6)', 'PTR', 'SOA', 'SRV', 'Other'],
                    datasets: [{
                        data: [65, 15, 10, 3, 2, 5],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f59e0b',
                            '#10b981',
                            '#3b82f6',
                            '#6b7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        }
                    }
                }
            });
            
            // Blocked categories
            const blockedCtx = document.getElementById('blockedCategoriesChart').getContext('2d');
            new Chart(blockedCtx, {
                type: 'bar',
                data: {
                    labels: ['Ads', 'Tracking', 'Malware', 'Phishing', 'Adult', 'Social'],
                    datasets: [{
                        label: 'Blocked Today',
                        data: [1234, 856, 342, 128, 67, 234],
                        backgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
            
            // Speed gauge
            const speedCtx = document.getElementById('speedGauge').getContext('2d');
            new Chart(speedCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [85, 15],
                        backgroundColor: ['#10b981', '#1e293b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
            
            // Security gauge
            const securityCtx = document.getElementById('securityGauge').getContext('2d');
            new Chart(securityCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [92, 8],
                        backgroundColor: ['#667eea', '#1e293b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }
        
        // Allow Enter key to trigger test
        document.getElementById('domain-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                testDNS();
            }
        });
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateMetrics();
            // Update metrics every 5 seconds
            setInterval(updateMetrics, 5000);
        });
    </script>
</body>
</html>
