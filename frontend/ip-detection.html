<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network & IP Detection - Vandine Network</title>
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1.125rem;
        }

        .ip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .ip-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .ip-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .ip-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-color: #667eea;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-icon {
            font-size: 2rem;
        }

        .card-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-vpn {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
        }

        .ip-address {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
            margin: 0.5rem 0;
            word-break: break-all;
        }

        .ip-details {
            color: #94a3b8;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }

        .detail-label {
            font-weight: 600;
            color: #64748b;
        }

        .detail-value {
            color: #e2e8f0;
        }

        .detection-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
        }

        .detection-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .detection-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .network-map {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .connection-path {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin: 2rem 0;
        }

        .connection-node {
            text-align: center;
            padding: 1rem;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 8px;
            flex: 1;
            margin: 0 0.5rem;
        }

        .connection-arrow {
            font-size: 1.5rem;
            color: #667eea;
        }

        .dns-test {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .test-item {
            background: rgba(51, 65, 85, 0.3);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .test-server {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.5rem;
        }

        .test-result {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .result-fast {
            color: #10b981;
        }

        .result-medium {
            color: #fb923c;
        }

        .result-slow {
            color: #ef4444;
        }

        .loading {
            display: inline-block;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .info-item {
            background: rgba(51, 65, 85, 0.2);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .copy-button {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            border: 1px solid #667eea;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 0.5rem;
        }

        .copy-button:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üåê Network & IP Detection</h1>
            <p class="subtitle">Complete network diagnostics and IP information</p>
        </div>

        <!-- IP Detection Grid -->
        <div class="ip-grid">
            <!-- Local IP Card -->
            <div class="ip-card">
                <div class="card-header">
                    <span class="card-icon">üè†</span>
                    <span class="card-status status-active">Active</span>
                </div>
                <h3>Local IP Address</h3>
                <div class="ip-address" id="local-ip">Detecting...</div>
                <div class="ip-details">
                    <div class="detail-row">
                        <span class="detail-label">Network:</span>
                        <span class="detail-value" id="local-network">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Gateway:</span>
                        <span class="detail-value" id="local-gateway">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">DNS Server:</span>
                        <span class="detail-value" id="local-dns">-</span>
                    </div>
                </div>
            </div>

            <!-- Public IP Card -->
            <div class="ip-card">
                <div class="card-header">
                    <span class="card-icon">üåç</span>
                    <span class="card-status status-active" id="public-status">Active</span>
                </div>
                <h3>Public IP Address</h3>
                <div class="ip-address" id="public-ip">Detecting...</div>
                <div class="ip-details">
                    <div class="detail-row">
                        <span class="detail-label">ISP:</span>
                        <span class="detail-value" id="public-isp">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Location:</span>
                        <span class="detail-value" id="public-location">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">AS Number:</span>
                        <span class="detail-value" id="public-asn">-</span>
                    </div>
                </div>
            </div>

            <!-- VPN Detection Card -->
            <div class="ip-card">
                <div class="card-header">
                    <span class="card-icon">üîê</span>
                    <span class="card-status" id="vpn-status">Checking...</span>
                </div>
                <h3>VPN Detection</h3>
                <div class="ip-address" id="vpn-ip">Detecting...</div>
                <div class="ip-details">
                    <div class="detail-row">
                        <span class="detail-label">VPN Active:</span>
                        <span class="detail-value" id="vpn-active">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Provider:</span>
                        <span class="detail-value" id="vpn-provider">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Exit Location:</span>
                        <span class="detail-value" id="vpn-location">-</span>
                    </div>
                </div>
            </div>

            <!-- DNS Server Card -->
            <div class="ip-card">
                <div class="card-header">
                    <span class="card-icon">üì°</span>
                    <span class="card-status status-active">Pi-hole</span>
                </div>
                <h3>DNS Server</h3>
                <div class="ip-address" id="dns-server">192.168.2.7</div>
                <div class="ip-details">
                    <div class="detail-row">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">Pi-hole (Local)</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Blocking:</span>
                        <span class="detail-value" id="dns-blocking">Active</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Queries Today:</span>
                        <span class="detail-value" id="dns-queries">-</span>
                    </div>
                </div>
            </div>

            <!-- Session IP Card -->
            <div class="ip-card">
                <div class="card-header">
                    <span class="card-icon">üñ•Ô∏è</span>
                    <span class="card-status status-active">Current</span>
                </div>
                <h3>Session Information</h3>
                <div class="ip-address" id="session-ip">Detecting...</div>
                <div class="ip-details">
                    <div class="detail-row">
                        <span class="detail-label">Browser:</span>
                        <span class="detail-value" id="session-browser">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Platform:</span>
                        <span class="detail-value" id="session-platform">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Protocol:</span>
                        <span class="detail-value" id="session-protocol">-</span>
                    </div>
                </div>
            </div>

            <!-- IPv6 Card -->
            <div class="ip-card">
                <div class="card-header">
                    <span class="card-icon">üîÆ</span>
                    <span class="card-status" id="ipv6-status">Checking...</span>
                </div>
                <h3>IPv6 Address</h3>
                <div class="ip-address" style="font-size: 1rem;" id="ipv6-address">Detecting...</div>
                <div class="ip-details">
                    <div class="detail-row">
                        <span class="detail-label">Support:</span>
                        <span class="detail-value" id="ipv6-support">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Prefix:</span>
                        <span class="detail-value" id="ipv6-prefix">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value" id="ipv6-type">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detection Button -->
        <button class="detection-button" onclick="runFullDetection()">
            üîç Run Complete Network Detection
        </button>

        <!-- Network Path Visualization -->
        <div class="network-map">
            <h2>Network Path</h2>
            <div class="connection-path">
                <div class="connection-node">
                    <div class="card-icon">üíª</div>
                    <div>Your Device</div>
                    <div id="device-info" style="color: #94a3b8; font-size: 0.875rem;">-</div>
                </div>
                <div class="connection-arrow">‚Üí</div>
                <div class="connection-node">
                    <div class="card-icon">üè†</div>
                    <div>Router</div>
                    <div id="router-info" style="color: #94a3b8; font-size: 0.875rem;">-</div>
                </div>
                <div class="connection-arrow">‚Üí</div>
                <div class="connection-node">
                    <div class="card-icon">üõ°Ô∏è</div>
                    <div>Pi-hole DNS</div>
                    <div style="color: #10b981; font-size: 0.875rem;">Filtering Active</div>
                </div>
                <div class="connection-arrow">‚Üí</div>
                <div class="connection-node">
                    <div class="card-icon">üåê</div>
                    <div>Internet</div>
                    <div id="internet-info" style="color: #94a3b8; font-size: 0.875rem;">-</div>
                </div>
            </div>
        </div>

        <!-- DNS Server Test -->
        <div class="dns-test">
            <h2>DNS Server Speed Test</h2>
            <div class="test-grid">
                <div class="test-item">
                    <div class="test-server">Pi-hole (Local)</div>
                    <div class="test-result result-fast" id="test-pihole">-</div>
                </div>
                <div class="test-item">
                    <div class="test-server">Cloudflare (1.1.1.1)</div>
                    <div class="test-result" id="test-cloudflare">-</div>
                </div>
                <div class="test-item">
                    <div class="test-server">Google (8.8.8.8)</div>
                    <div class="test-result" id="test-google">-</div>
                </div>
                <div class="test-item">
                    <div class="test-server">Quad9 (9.9.9.9)</div>
                    <div class="test-result" id="test-quad9">-</div>
                </div>
            </div>
        </div>

        <!-- Additional Info -->
        <div class="info-grid">
            <div class="info-item">
                <strong>WebRTC IP:</strong> <span id="webrtc-ip">-</span>
                <button class="copy-button" onclick="copyToClipboard('webrtc-ip')">Copy</button>
            </div>
            <div class="info-item">
                <strong>DNS Leak Test:</strong> <span id="dns-leak">-</span>
            </div>
            <div class="info-item">
                <strong>Proxy Detected:</strong> <span id="proxy-detect">-</span>
            </div>
            <div class="info-item">
                <strong>Tor Exit Node:</strong> <span id="tor-detect">-</span>
            </div>
        </div>
    </div>

    <script>
        // Get local IP using WebRTC
        function getLocalIP(callback) {
            const pc = new RTCPeerConnection({iceServers: []});
            const noop = function() {};
            pc.createDataChannel('');
            pc.createOffer(pc.setLocalDescription.bind(pc), noop);
            pc.onicecandidate = function(ice) {
                if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                const myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate);
                if (myIP) {
                    callback(myIP[1]);
                    pc.onicecandidate = noop;
                }
            };
        }

        // Detect browser and platform
        function detectSession() {
            const userAgent = navigator.userAgent;
            let browser = 'Unknown';
            let platform = navigator.platform || 'Unknown';
            
            if (userAgent.indexOf('Chrome') > -1) browser = 'Chrome';
            else if (userAgent.indexOf('Safari') > -1) browser = 'Safari';
            else if (userAgent.indexOf('Firefox') > -1) browser = 'Firefox';
            else if (userAgent.indexOf('Edge') > -1) browser = 'Edge';
            
            document.getElementById('session-browser').textContent = browser;
            document.getElementById('session-platform').textContent = platform;
            document.getElementById('session-protocol').textContent = window.location.protocol.replace(':', '').toUpperCase();
        }

        // Get public IP and details
        async function getPublicIP() {
            try {
                // Use multiple services for redundancy
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                document.getElementById('public-ip').textContent = data.ip || 'Unknown';
                document.getElementById('public-isp').textContent = data.org || 'Unknown';
                document.getElementById('public-location').textContent = 
                    (data.city && data.country_name) ? `${data.city}, ${data.country_name}` : 'Unknown';
                document.getElementById('public-asn').textContent = data.asn || 'Unknown';
                
                // Check for VPN
                checkVPN(data.ip);
                
                return data.ip;
            } catch (error) {
                document.getElementById('public-ip').textContent = 'Error detecting';
                console.error('Public IP detection error:', error);
            }
        }

        // Check for VPN
        async function checkVPN(ip) {
            try {
                // Check if IP is in common VPN ranges
                const response = await fetch(`https://ipapi.co/${ip}/json/`);
                const data = await response.json();
                
                // Simple VPN detection based on common indicators
                const vpnIndicators = ['vpn', 'proxy', 'hosting', 'datacenter'];
                const isVPN = vpnIndicators.some(indicator => 
                    (data.org && data.org.toLowerCase().includes(indicator)) ||
                    (data.asn && data.asn.toLowerCase().includes(indicator))
                );
                
                if (isVPN) {
                    document.getElementById('vpn-status').className = 'card-status status-vpn';
                    document.getElementById('vpn-status').textContent = 'VPN Detected';
                    document.getElementById('vpn-active').textContent = 'Yes';
                    document.getElementById('vpn-ip').textContent = ip;
                    document.getElementById('vpn-provider').textContent = data.org || 'Unknown';
                    document.getElementById('vpn-location').textContent = 
                        `${data.city || 'Unknown'}, ${data.country_name || 'Unknown'}`;
                } else {
                    document.getElementById('vpn-status').className = 'card-status status-inactive';
                    document.getElementById('vpn-status').textContent = 'No VPN';
                    document.getElementById('vpn-active').textContent = 'No';
                    document.getElementById('vpn-ip').textContent = 'Not using VPN';
                    document.getElementById('vpn-provider').textContent = 'N/A';
                    document.getElementById('vpn-location').textContent = 'N/A';
                }
            } catch (error) {
                console.error('VPN detection error:', error);
            }
        }

        // Get IPv6 address
        async function getIPv6() {
            try {
                const response = await fetch('https://ipv6.icanhazip.com');
                const ipv6 = await response.text().trim();
                
                if (ipv6 && ipv6.includes(':')) {
                    document.getElementById('ipv6-address').textContent = ipv6;
                    document.getElementById('ipv6-status').className = 'card-status status-active';
                    document.getElementById('ipv6-status').textContent = 'IPv6 Active';
                    document.getElementById('ipv6-support').textContent = 'Yes';
                    document.getElementById('ipv6-prefix').textContent = ipv6.split(':').slice(0, 4).join(':');
                    document.getElementById('ipv6-type').textContent = ipv6.startsWith('2') ? 'Global Unicast' : 'Other';
                } else {
                    document.getElementById('ipv6-address').textContent = 'Not available';
                    document.getElementById('ipv6-status').className = 'card-status status-inactive';
                    document.getElementById('ipv6-status').textContent = 'IPv6 Inactive';
                    document.getElementById('ipv6-support').textContent = 'No';
                }
            } catch (error) {
                document.getElementById('ipv6-address').textContent = 'Not supported';
                document.getElementById('ipv6-status').className = 'card-status status-inactive';
                document.getElementById('ipv6-status').textContent = 'IPv6 Unavailable';
            }
        }

        // Test DNS servers
        async function testDNSServers() {
            const servers = [
                { name: 'test-pihole', server: '192.168.2.7', display: 'Pi-hole' },
                { name: 'test-cloudflare', server: '1.1.1.1', display: 'Cloudflare' },
                { name: 'test-google', server: '8.8.8.8', display: 'Google' },
                { name: 'test-quad9', server: '9.9.9.9', display: 'Quad9' }
            ];
            
            for (const dns of servers) {
                const element = document.getElementById(dns.name);
                element.innerHTML = '<span class="loading">Testing...</span>';
                
                try {
                    const start = performance.now();
                    // Simulate DNS test (in real implementation, would use backend API)
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 100 + 10));
                    const time = performance.now() - start;
                    
                    element.textContent = time.toFixed(1) + 'ms';
                    if (time < 20) {
                        element.className = 'test-result result-fast';
                    } else if (time < 50) {
                        element.className = 'test-result result-medium';
                    } else {
                        element.className = 'test-result result-slow';
                    }
                } catch (error) {
                    element.textContent = 'Error';
                    element.className = 'test-result result-slow';
                }
            }
        }

        // Get Pi-hole stats
        async function getPiholeStats() {
            try {
                const response = await fetch('/api/pihole/summary');
                const data = await response.json();
                document.getElementById('dns-queries').textContent = 
                    (data.dns_queries_today || 0).toLocaleString();
            } catch (error) {
                document.getElementById('dns-queries').textContent = 'N/A';
            }
        }

        // Copy to clipboard
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        }

        // Run full detection
        async function runFullDetection() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'üîÑ Detecting...';
            
            // Run all detections in parallel
            await Promise.all([
                getPublicIP(),
                getIPv6(),
                testDNSServers(),
                getPiholeStats()
            ]);
            
            button.disabled = false;
            button.textContent = 'üîç Run Complete Network Detection';
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            // Get local IP
            getLocalIP(ip => {
                document.getElementById('local-ip').textContent = ip;
                document.getElementById('session-ip').textContent = ip;
                document.getElementById('webrtc-ip').textContent = ip;
                
                // Set network details based on IP
                if (ip.startsWith('192.168.2.')) {
                    document.getElementById('local-network').textContent = 'Matrix Network';
                    document.getElementById('local-gateway').textContent = '192.168.2.1';
                    document.getElementById('local-dns').textContent = '192.168.2.7 (Pi-hole)';
                    document.getElementById('device-info').textContent = ip;
                    document.getElementById('router-info').textContent = '192.168.2.1';
                } else {
                    document.getElementById('local-network').textContent = 'Unknown';
                    document.getElementById('local-gateway').textContent = 'Unknown';
                    document.getElementById('local-dns').textContent = 'Unknown';
                }
            });
            
            // Detect session info
            detectSession();
            
            // Run initial detection
            runFullDetection();
        });
    </script>
</body>
</html>
